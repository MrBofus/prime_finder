#include <iostream>
#include "prime_functions_fast.h"

FILE* primefile = fopen("factors2.txt", "a");

int factorize(mpz_t prime, unsigned int p, int min_digits) {
    int count = 0;

    mpz_t n, comparator, iterator, square_root;
    mpz_inits(n, comparator, iterator, square_root, NULL);
    mpz_set(n, prime);
    mpz_set(comparator, n);
 
    // count the number of times 2 divides
    mpz_mod_ui(comparator, n, 2);
    while ( mpz_cmp_ui(comparator, 0) == 0 ){
        mpz_rshift(n, n, 1); // equivalent to n=n/2;
        count++;

        mpz_set(comparator, n);
        mpz_mod_ui(comparator, n, 2);
    }
 
    // if 2 divides it
    if (count){
        fputs("2 ", primefile);
        fprintf(primefile, "%u", count);
        fputs("\n", primefile);
    }

    if (mpz_cmp_ui(n, 0) < 0){
        mpz_clears(n, comparator, iterator, square_root, NULL);
        return 0;
    }
 
    mpz_set(comparator, n);
    mpz_sqrt(square_root, n);
    mpz_set_ui(iterator, 3);

    // check for all the possible numbers that can
    // divide it
    while (mpz_cmp(iterator, square_root) <= 0) {
        count = 0;

        mpz_mod(comparator, n, iterator);
        while (mpz_cmp_ui(comparator, 0) == 0) {
            count++;
            mpz_div(n, n, iterator);
            mpz_set(comparator, n);
            mpz_mod(comparator, n, iterator);
        }

        if (count) {
            mpz_out_str(primefile, 10, iterator);
            fputs(" ", primefile);
            fprintf(primefile, "%u", count); 
            fputs("\n", primefile);
        }

        mpz_add_ui(iterator, iterator, 2);
    }

    // if n at the end is a prime number.
    if ( mpz_cmp_ui(n, 2) > 0 ){
        size_t length = mpz_sizeinbase(n, 10);
        
        if (length < min_digits) {
            mpz_out_str(primefile, 10, n);
            fputs(" 1\n", primefile);

            cout << "\n found one -- " << p << endl;
            // gmp_printf ("%Zd 1\n", n);
        }
        else{
            fputs("factor was too long\n", primefile);
        }
    }
    else {cout << "\n found one -- " << p << endl;}
    
    mpz_clears(n, comparator, iterator, square_root, NULL);
    return 0;
}

int main(void) {
    mpz_t prime;
    mpz_init(prime);
    mpz_set_str(prime, "5684634968413845", 10);
    //mpz_set_str(prime, "80861416431412028547670544149942558542842285212998214450856994729089099285101752322620637494787164527631645128244704998068844358444033402131368702831188149134045441957347287104065112542244946043664213321719587911829027591742275463140898678346255026216707694309353515709158736059863515616636768217298077460772947511267139758696439983004296788165265801557345358285161126008678628679611398754351648636777526181899232858682756886632950408484282833902540463604330109733211012804262735720799454331556438014810745465798262110768537318615795661089475718492276412649597124516221052104505231701736563009737393216107567329405928557919398923345806670242478567052810520876369888856212613879298666084110878168943953094521791893907098255324866068671839557992028320041615793260741894538097197570259424895919074404293294236133637095452448999076989081452132656314495252687000196487139023081251179063925732979263412706419387709710138724771491028253376118940248468441346306678359634745554343907385058292933846139521317475347604252121132366568245583556982986720090366806926291343789970682920441004967414387935326428793821427525358000634865349373169879253432464436778635566741959378349007002346225035125961189731591389096211581802847274838026054831299489564060834516216767490013322011401586535326607406035189330298691482008028313354515375679716929045275167057406797411820948506488090207596095008011593906844120852564912905968300483584403103856105965202264648287332541132599701577410747567732299141925298715043066304917623856214897327738047031131145353859803991665782875667909438484823735879962049087733534212004081333744735459786866946304514378366223720287853599825392588468862137495723033220329801668591979273217760853122110977645672948595948624989968772735051435023507180551601617562242200530773217481428701177767295461004108276334190894121474475303957193329858745359393551137873632238855503350931993105074695673859049351556211828585874734093721343764279440381495314752886081643634381089540771041697511046448229333815401114257871792768829703626511563507619132691679110170258630811493814374816021631695909861158667225602335484023691787242895149058786251360880705493934063345892370458798485791686990317881320437023896480388701275660706565354586727985870937899767403994415113685585148144282535637523195126732165724983660507595269590054106496637433754228519472567542972501364256958675202290389319949959434464918786940026446087512037282330745000178125735660241693006614506362688647491444197705204363743014516491493478559045906693060490700954175270189035306702500971338831197583757992000836504650901938288913607466665572699017719295860330285008128125677658552542758781912648429181808867888280757092265079438356984677993034667953723108272635420127392800230672467880303267367066624869143979471757847817396899834695525226649437801137613936036427195417811657294987244768726781296915588462959008645335052521513905657670597496390513163699125955192314004950435073597332715658349377530589472831639626784727011640319432610390424953625662032771141183068040413082027401166095639351760455902540555052809748409731533459081120280311657569369032616067767513440240028751520303715304813688128783477747957250672336943553000347608266687114724229107612637786542375185144325545304943465267273599328802365102791110271208182603219823697866048969437395045564958162728086211421706157093725345613069799374238238305540554178607434105699321767415057373538539225156271076983765543209477111894143932946388746011119822857454841312238331304748662038334867092241278165070583097271882137267799519177668270097597407577147100562711880667501417036622433564582213052231670015766185244221502538845633680613946508522484128999344566765173883493349171960705840080757297732204130782619333454796499829057041536334939263637912624806262823904615872156062446373203765669569606978946040670001563457715337457234542918418265047092902985411752813577362810195238517006466351641828935651033271500330286635178970673249313399626832553084109342250718500550373287341236751280869645274094716832712266917543422161697990554257987158587452373764973924392819752468842229504294685927772218593055297851583588901706545374515834081980472498738684483282336327170279019171672641688667065026739833168284222731972864675419051767036050438206838425258353930465313085801196083272120075319624151326958872148511976773734632659140508562893398394204310146748176280818193355241698166774015760683791424653671959052582634585883671348662922609484778328753484321259277622530258319556126048900247559522005725048123913423025933984457482446097016030191165244894296631872809648972335718189374378633980555022291030076244876888526984871557043135383974568187398171339311028191788916438988487824679333627525922947043092842768033237716380858696345474995406176634230033056061399590437907191087419741698518432836992733829584761717822748165105115975376811303869838475507070495397980448871191228565469962748068516623783735844723970144751822486983934158669120411305042582931531475723072580565652194418236757997925670777802914092469904043151216204302458183795148084974831991520691658905320921519487628698783884649093086722401321532366789665264607465197246397836553852919156175089485114403397684010619864551749476194207677753809950801375158039509599349041366668951515891112805808499421106094703430939299599086689965137928441045692623442284399563632570048923771672467933677459958459420200325309520661420998349696579799144697127497831027441924631645419264566433230875874010994723219785836106324698010951305821983993062709571392693827700589350609408683518312382183114397565730548114607383064362239107000909176125477789641343333258032006148437741312047626044691541145008646240363903958335435994309151719019355916946862004650686838708084975685629318051057542186463239634476074484505234963803294393916287548279286434242790186717844253351907322622033218844374191265991601635773054900402545364855285107674089806835877722055245095235879714739432191986342746166365192416102870704083077554455149662525090924626922611957545089841319751326965832521604863213277209490206764739334322356541818003096522353066820466871632293765938182624473009929703251842355331547000773589076334424641238905274214153864565704146864548204931117761153437617073477179466430218787045902272397315543852454134514703464483776226038616655376503004250103658181630674048603502922290170875189411188835574879444903773643813359159368836687137755575400895699425660651021287375775447091108502079734680123696056666625121442987592820185119704769559953584608395389197939254888531457311559188718610348493800054300361692607986079329997960500631887648593648707762459676095643928802389026604313488367553811161906682269093103067547155216532563183966970313791179698516358877276486760733892250260126449617454026862619893315087829590077420527606491540814313750576667058868046783465642160446559728119001122749858487410272731421677883352710936110693529571339636714800667820309928495387863713015128828727009310327950729849519034066460064893544973302315496906811539744614456156450772725161061139911178103361655590670062517868795123287664201457446900211091098580373301155768196388286380079552000416140903681443644706362210299044069045495311997566082547812474926311199500468925759379090463978610753771232198467662605057488422147034924401272511875542429268589472636337292088923728313889260669842440485056917288775369860442762071312373661047069532676871549399495830618298814010473282117928598910377985039858979186043530162803451650333313731581034547236284905412348718498652399397464468148178198224597968647280905831279465535759762878267772351184204266789791459161203650805349463573190450814156331935082739603938431769165442205164328172856382086690654000466776556293683854735723307542787988018456825753003211370454452071077581000479052370168466816303020034239519505089511528182463683401105405415130720811147736476331552238427794449691798780236951677637056749442176983870690295131369700346069641974149555608931241252612750475839742384163613764880146730695551967587319481999096238837148255193874703229582709003581126497888155858967951835670149523135122874849243133093471088618624818092072329794640414962867571201147168927873991303732513899810411693120155789211687146987620830266014063797877983445081647781247145075970865827143450409287434162629320941197292525996816384325557928284705600718254024239353481791070264548380836619483762300989901968499013740896936390832736329664934100103707270065771411802468124984735852441156470475236051456020788236166861035622756506159914545670372889922855397451874178895682553764860658850437505978043702502482185858185779206929609236550760671540676749729068040324574526390556686533119220728141071030768636657574419444219250681425935005771241783335808735319105524875301752931498790367561405147086085005186616159137504656969899181212542494442859777092911060484461526560824083573890789930879829868764861419405908489603429969550855571121181166815086593368830777722530577437256779099882971989256403195818140395829861480911856164403879524635993785721502578535539231336607830059402725777771230314896090890837039601482896641093034731481530303012506766250639053770708873209193548452661652122001087834524226150919314468719022840313166030027726018510324788850617774190954016400948688453697581907767561578512301443843502723413550166608330414446755801057817878859294839812988327044293045179081227377803073127743705415569041425747481226244504466729375436366796961764810816844640130021527946339274868293685391803374337932738261727282357445973647688843463629184109498882642601659348718727179848080275331854080963952143032245992923134966030019381893618600074259033712372566072062891919356143704571110172993240209378805999101197844972895707922740619119418972957777274944285061942603865306318667116007052067662932903803567065295696601607390636677154489396892598504484914575523576953246198897789477595818571415478993668341953841774240579491310991300696455707282977967972863651657378811887110997032461818539733134469741386196409632111743196060513903712256674769273315596657488540975170147352991033501899676379313208800626592008346296753375567007820055903544582035005946105476035352369", 10);

    for (unsigned int i = 1; i < 1000; i++) {
        cout << "\rtrying f = " << i;
        cout.flush();

        fputs("\n`````````````````````````````````````\n", primefile);
        fprintf(primefile, "%d", i);
        fputs("\n`````````````````````````````````````\n", primefile);
        
        mpz_sub_ui(prime, prime, 1);
        int j = factorize(prime, i, 3);

        fputs("\n`````````````````````````````````````\n", primefile);
    }

    cout << "\n";

    fclose(primefile);
    mpz_clear(prime);
    return 0;
}